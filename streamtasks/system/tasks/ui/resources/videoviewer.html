<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>video viewer</title>
    <script src="https://www.unpkg.com/mpegts.js@1.7.3/dist/mpegts.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #videoElement {
            display: block;
            box-sizing: border-box;
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>
    <video id="videoElement" autoplay controls></video>
    <script type="module">
        import * as Mp4Muxer from 'https://cdn.jsdelivr.net/npm/mp4-muxer@4.3.3/+esm';

        const videoCodec = "avc1.4d001e"; // 6016100
        const videoElement = document.querySelector('#videoElement');
        const configUrl = new URL("./config.json", location.href);
        const videoUrl = new URL("./video", location.href);
        videoUrl.protocol = "ws:";

        const startPlaying = async () => {
            const config = await fetch(configUrl).then(res => res.json());

            let mediaSource = new MediaSource();
            videoElement.src = URL.createObjectURL(mediaSource);
            //videoElement.play();

            await new Promise(resolve => mediaSource.onsourceopen = resolve);

            let sourceBuffer = mediaSource.addSourceBuffer(`video/mp4; codecs="${videoCodec}"`);

            const muxer = new Mp4Muxer.Muxer({
                target: new Mp4Muxer.StreamTarget({
                    onData: buffer => sourceBuffer.appendBuffer(buffer)
                }),
                video: {
                    codec: 'avc',
                    width: config.width,
                    height: config.height,
                    optimizeForLatency: true
                },
                fastStart: 'fragmented',
                firstTimestampBehavior: 'strict'
            });

            const videoSocket = new WebSocket(videoUrl);
            videoSocket.binaryType = "arraybuffer";

            videoSocket.addEventListener("close", () => console.log("Closed video socket!"));
            videoSocket.addEventListener("error", (e) => console.error("Error:", e));
            videoSocket.addEventListener("open", (e) => console.log("Opened video socket!"));
            videoSocket.addEventListener("message", (e) => {
                if (!(e.data instanceof ArrayBuffer)) {
                    console.error("Expected arraybuffer...");
                    return;
                }

                const data = new Uint8Array(e.data);
                const dataView = new DataView(e.data);
                const isKeyframe = dataView.getUint8(0) != 0;
                const uPts = Number(dataView.getBigUint64(1));
                const uRelDts = dataView.getUint32(9);

                //console.log(isKeyframe, uPts, uRelDts);
                //console.log(data.subarray(13).map(x => x.toString(16).padStart(2, '0')).join(''))

                muxer.addVideoChunkRaw(data.subarray(13), isKeyframe ? "key" : "delta", uPts, config.duration, {
                    decoderConfig: {
                        codec: videoCodec,
                        codedHeight: config.height,
                        codedWidth: config.width
                    }
                }, uRelDts);
            });

            mediaSource.addEventListener("sourceended", e => {
                console.log("Media source ended!", e);
                videoSocket.close();
            });

        }

        startPlaying();

    </script>
</body>
</html>